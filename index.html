<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Care â€“ QA Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #030712;
      --card-bg: rgba(15, 23, 42, 0.96);
      --border-subtle: rgba(148, 163, 184, 0.35);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-lg: 18px;
      --shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.6);
    }

    body.light {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --card-bg: #ffffff;
      --border-subtle: rgba(148, 163, 184, 0.28);
      --accent: #0ea5e9;
      --accent-soft: rgba(14, 165, 233, 0.08);
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --shadow-soft: 0 14px 38px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, var(--bg-soft), var(--bg));
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 24px;
      transition: background 0.25s ease, color 0.25s ease;
    }

    body.no-scroll {
      overflow: hidden; /* used when dropdown is open */
    }

    .shell {
      width: 100%;
      max-width: 1280px;
    }

    .layout-stack {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* Header */

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .title-block h1 {
      margin: 0 0 2px;
      font-size: 28px;
      letter-spacing: 0.05em;
    }

    .title-block span.sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Logo */

    .logo {
  width: auto;
  height: 100px;         /* Adjust if needed */
  background: none;
  border: none;
  border-radius: 0;
  overflow: visible;
  display: flex;
  align-items: center;
  justify-content: flex-start;
}


    body.light .logo {
      background: #e5f0ff;
      border-color: rgba(148, 163, 184, 0.4);
    }

    .logo-img {
      width: 180%;
      height: 180%;
      object-fit: contain;
    }

    .header-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .timestamp {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    .btn {
      border: 1px solid transparent;
      padding: 7px 13px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      color: var(--text-main);
      transition: all 0.12s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #0b1120;
      box-shadow: 0 10px 22px rgba(56, 189, 248, 0.4);
      border-color: transparent;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(56, 189, 248, 0.55);
    }

    .btn-ghost {
      border-color: var(--border-subtle);
      background: rgba(15, 23, 42, 0.3);
    }

    body.light .btn-ghost {
      background: rgba(255, 255, 255, 0.9);
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-icon {
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Cards */

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 16px 18px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .card.analytics-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(37,99,235,0.22), transparent 55%);
      opacity: 0.7;
      z-index: -1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(56, 189, 248, 0.5);
      color: var(--accent);
    }

    .subtle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    

    /* Filter card */

    .filters-card {
  background: var(--card-bg);                 /* same as analytics card */
  border: 1px solid var(--border-subtle);
  box-shadow: var(--shadow-soft);
  color: var(--text-main);
  border-radius: var(--radius-lg);
  padding: 16px 18px;

  overflow: visible;                          /* let dropdown escape */
  position: relative;                         /* create stacking context */
  z-index: 5;                                 /* above analytics card */
}


    body.light .filters-card {
      background: linear-gradient(
        135deg,
        #ffffff,
        #e5f0ff,
        #f0f9ff
      );
      border-color: rgba(129,140,248,0.4);
      color: #0f172a;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: flex-end;
      margin-top: 4px;
    }

    .select,
    .input {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 12px;
      padding: 8px 12px;
      outline: none;
      min-width: 145px;
      transition: border 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, transform 0.08s ease;
    }

    body.light .select,
    body.light .input {
      background: #ffffff;
    }

    .select:focus,
    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
      transform: translateY(-1px);
    }

    .filters .label {
      font-size: 11px;
      color: var(--text-muted);
      margin-right: 2px;
      white-space: nowrap;
    }

    .status-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: auto;
      white-space: nowrap;
    }

    .quick-ranges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .range-btn {
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.9);
      background: rgba(15,23,42,0.15);
      color: #e5e7eb;
      font-size: 11px;
      padding: 5px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.12s ease;
    }

    .range-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #38bdf8;
    }

    .range-btn:hover {
      background: rgba(56,189,248,0.16);
      border-color: rgba(56,189,248,0.9);
      transform: translateY(-1px);
    }

    .range-btn.active {
      background: rgba(56,189,248,0.22);
      border-color: rgba(56,189,248,1);
    }

    body.light .range-btn {
      background: rgba(255,255,255,0.9);
      color: #111827;
      border-color: rgba(148,163,184,0.7);
    }

    body.light .range-btn:hover {
      background: #e0f2fe;
      border-color: #38bdf8;
    }

    body.light .range-btn.active {
      background: #dbeafe;
      border-color: #0ea5e9;
    }

    /* Active filters summary */

    .active-filters {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .chips-container {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 12px;
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid var(--accent);
      color: var(--accent);
      white-space: nowrap;
    }

    .chip-muted {
      opacity: 0.7;
      font-style: italic;
    }
    .chip-close {
  margin-left: 6px;
  cursor: pointer;
  font-weight: bold;
}
.chip-close:hover {
  opacity: 0.7;
}


    /* Custom multi-select */

    .agent-select-block {
      position: relative;
    }

    .multi-select {
      min-width: 230px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    body.light .multi-select {
      background: white;
    }

    .dropdown-icon {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 6px;
    }

    .multi-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 6px;
      width: 260px;
      height: 260px;        /* fixed panel height */
      overflow-y: auto;     /* internal scroll only */
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      border-radius: 14px;
      padding: 10px;
      z-index: 999;
    }

    .multi-search {
      width: 100%;
      padding: 6px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-main);
      font-size: 12px;
    }

    body.light .multi-search {
      background: white;
    }

    .multi-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 2px;
      cursor: pointer;
      font-size: 12px;
    }

    .multi-option:hover {
      background: rgba(56, 189, 248, 0.15);
      border-radius: 6px;
    }

    /* KPIs */

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 6px;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .kpi-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .kpi {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%);
    }

    body.light .kpi {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), #ffffff);
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 4px;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .kpi-delta {
      font-size: 11px;
      margin-top: 2px;
    }

    .kpi-delta.positive { color: #22c55e; }
    .kpi-delta.negative { color: #ef4444; }

    /* Leaderboard */

    .leaderboard {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(148,163,184,0.4);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .leader-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .leader-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 10px;
      font-size: 11px;
      flex-wrap: wrap;
    }

    .leader-badge {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.5);
    }

    body.light .leader-badge {
      background: rgba(255,255,255,0.9);
    }

    /* Charts */

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .chart-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 10px 10px 6px;
    }

    body.light .chart-card {
      background: #ffffff;
      border-color: rgba(148, 163, 184, 0.6);
    }

    .chart-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px 4px;
    }

    .chart-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
    }

    .trend-select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: var(--text-main);
      font-size: 11px;
      padding: 4px 8px;
      outline: none;
    }

    body.light .trend-select {
      background: #ffffff;
    }

    canvas {
      width: 100% !important;
      height: 210px !important;
    }

    /* Raw table */

    .table-wrap {
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.92);
      margin-top: 10px;
      overflow-x: auto;
    }

    body.light .table-wrap {
      border-color: rgba(148, 163, 184, 0.75);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 11px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: rgba(15, 23, 42, 0.98);
    }

    body.light thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 7px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }

    body.light th,
    body.light td {
      border-bottom-color: rgba(209, 213, 219, 0.9);
    }

    th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.96);
    }

    body.light tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, 0.35);
    }

    body.light tbody tr:hover {
      background: rgba(191, 219, 254, 0.6);
    }

    .empty-state {
      text-align: center;
      padding: 28px 14px;
      font-size: 12px;
      color: var(--text-muted);
    }

    a.ticket-link {
      color: var(--accent);
      text-decoration: none;
    }

    a.ticket-link:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }

    
    /* Column visibility / filtering UI */

    .column-visibility {
      position: relative;
      margin-bottom: 10px;
    }

    .col-menu {
      position: absolute;
      top: 36px;
      left: 0;
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      padding: 10px;
      border-radius: 10px;
      box-shadow: var(--shadow-soft);
      z-index: 50;
      max-height: 260px;
      overflow-y: auto;
      width: 220px;
    }

    .col-menu label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 2px;
    }

    .header-filter {
      cursor: pointer;
      margin-left: 6px;
      font-size: 11px;
      opacity: 0.7;
    }

    .header-filter:hover {
      opacity: 1;
    }
    /* Skeleton loading styles */
    .skeleton {
      background: linear-gradient(90deg, 
        rgba(148, 163, 184, 0.1) 25%, 
        rgba(148, 163, 184, 0.2) 50%, 
        rgba(148, 163, 184, 0.1) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
      border-radius: 8px;
    }

    body.light .skeleton {
      background: linear-gradient(90deg, 
        rgba(148, 163, 184, 0.15) 25%, 
        rgba(148, 163, 184, 0.3) 50%, 
        rgba(148, 163, 184, 0.15) 75%);
      background-size: 200% 100%;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-kpi {
      height: 100px;
    }

    .skeleton-chart {
      height: 210px;
    }

    .skeleton-text {
      height: 20px;
      margin: 8px 0;
      width: 100%;
    }

    .skeleton-text.short {
      width: 60%;
    }

    /* Toast notification styles */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 14px 18px;
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      min-width: 280px;
      animation: toast-slide-in 0.3s ease-out;
      backdrop-filter: blur(18px);
    }

    @keyframes toast-slide-in {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes toast-slide-out {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: toast-slide-out 0.3s ease-out forwards;
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .toast-message {
      font-size: 11px;
      color: var(--text-muted);
    }

    .toast-close {
      cursor: pointer;
      font-size: 16px;
      opacity: 0.6;
      transition: opacity 0.2s;
      flex-shrink: 0;
    }

    .toast-close:hover {
      opacity: 1;
    }

    .toast.success {
      border-left: 3px solid #22c55e;
    }

    .toast.info {
      border-left: 3px solid var(--accent);
    }

    .toast.error {
      border-left: 3px solid #ef4444;
    }
  </style>
</head>
<body class="dark">
  <div class="shell">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <img src="dbmci-one-logo.png" alt="DBMCI One Logo" class="logo-img" />
        </div>
        <div class="title-block">
          <h1>Care â€“ QA Dashboard</h1>
          <span class="sub">One view for audits, QA findings, disputes & categories.</span>
        </div>
      </div>

      <div class="header-actions">
        <div class="timestamp">
          Last sync:<br />
          <span id="last-updated">â€“</span>
        </div>
        <button id="theme-toggle" class="btn btn-ghost" type="button">
          <span class="btn-icon" id="theme-icon">ðŸŒ™</span>
          <span id="theme-label">Dark</span>
        </button>
        <button id="refresh-btn" class="btn btn-primary" type="button">
          <span class="btn-icon">âŸ³</span>
          Refresh Data
        </button>
      </div>
    </header>

    <div class="layout-stack">
      <!-- TOP: FILTERS -->
      <section class="card filters-card">
        <div class="card-header">
          <div>
            <div class="card-title">Filters</div>
            <div class="subtle">All KPIs & charts respect these.</div>
          </div>
          <div class="status-text" id="status-text">
            Waiting to loadâ€¦
          </div>
        </div>

        <div class="filters">
          <!-- Custom multi-select Agent -->
          <div class="agent-select-block">
            <span class="label">Agent</span><br />
            <div id="agent-multiselect" class="multi-select">
              <div id="agent-selected-chips" class="chips-container">All agents</div>
              <div class="dropdown-icon">â–¼</div>
            </div>
            <div id="agent-dropdown" class="multi-dropdown hidden">
              <input type="text" id="agent-search" class="multi-search" placeholder="Search agentsâ€¦" />
              <div id="agent-options"></div>
            </div>
          </div>

          <div>
            <span class="label">From</span><br />
            <input id="from-date" class="input" type="date" />
          </div>

          <div>
            <span class="label">To</span><br />
            <input id="to-date" class="input" type="date" />
          </div>
        </div>

        <div class="active-filters" id="active-filters"></div>

        <div class="quick-ranges">
          <button class="range-btn" data-days="1">
            <span class="dot"></span> Last 1 day
          </button>
          <button class="range-btn" data-days="3">
            <span class="dot"></span> Last 3 days
          </button>
          <button class="range-btn" data-days="7">
            <span class="dot"></span> Last 7 days
          </button>
          <button class="range-btn" data-days="30">
            <span class="dot"></span> Last 30 days
          </button>
          <button class="range-btn" data-days="0" id="range-clear">
            âœ• Clear date filter
          </button>
        </div>
      </section>

      <!-- MIDDLE: ANALYTICS -->
      <section class="card analytics-card">
        <div class="card-header">
          <div class="card-title">Analytics Overview</div>
          <span class="pill" id="records-pill">0 rows</span>
        </div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-label">Tickets audited</div>
            <div class="kpi-value" id="kpi-tickets">0</div>
            <div class="kpi-sub">Total Tickets Audited</div>
            <div class="kpi-delta" id="kpi-tickets-delta">vs prev: â€”</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">QA found</div>
            <div class="kpi-value" id="kpi-qa-found">0</div>
            <div class="kpi-sub">Total QA Founds (excluding Feedback)</div>
            <div class="kpi-delta" id="kpi-qa-delta">vs prev: â€”</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Disputed</div>
            <div class="kpi-value" id="kpi-disputed">0</div>
            <div class="kpi-sub">Total Dispute cases</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Feedbacks</div>
            <div class="kpi-value" id="kpi-feedback">0</div>
            <div class="kpi-sub">Total Feedback Received</div>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
          <div class="leader-title">Top agents by QA found</div>
          <ol class="leader-list" id="leader-list"></ol>
        </div>

        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-header-row">
              <div class="chart-title">Tickets audited by auditor</div>
            </div>
            <canvas id="chart-tickets-agent"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header-row">
              <div class="chart-title">QA Found / Agent</div>
            </div>
            <canvas id="chart-qa-agent"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header-row">
              <div class="chart-title">QA Trend</div>
              <select id="trend-mode" class="trend-select">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <canvas id="chart-qa-trend"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header-row">
              <div class="chart-title">Disputed vs Not Disputed</div>
            </div>
            <canvas id="chart-disputes"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header-row">
              <div class="chart-title">QA by Category</div>
            </div>
            <canvas id="chart-category"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-header-row">
              <div class="chart-title">Email / Calls</div>
            </div>
            <canvas id="chart-channel"></canvas>
          </div>
        </div>
      </section>

      <!-- BOTTOM: RAW DATA -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Raw QA Data</div>
            <div class="subtle">
              Full table view of the analytics above.
            </div>
          </div>
          <button id="toggle-table-btn" class="btn btn-ghost" type="button">
            <span class="btn-icon">ðŸ“„</span>
            <span id="toggle-table-label">Show Raw Data</span>
          </button>
        </div>

        <!-- Column visibility / filters controller -->
        <div id="column-visibility" class="column-visibility">
          <button id="colToggleBtn" class="btn btn-ghost" type="button">
            âš™ Columns
          </button>
          <div id="colMenu" class="col-menu hidden"></div>
        </div>

        <div id="table-section" class="table-wrap hidden">
          <table id="data-table"></table>
        </div>
      </section>
    </div>
  </div>

  <!-- SCRIPT COMES FROM PART 2 -->
  <script>
    Chart.register(ChartDataLabels);

    // ===== COLUMN MAP (auto-detected) =====
    let COL_DATE          = "Date";
    let COL_MONTH         = "Month";
    let COL_WEEK          = "Week";
    let COL_AUDITOR       = "Auditor";
    let COL_AGENT         = "Agent";
    let COL_QA_FOUND      = "QA Founds";
    let COL_TICKET_COUNT  = "Ticket Count";
    let COL_TICKET_ID     = "Ticket id";
    let COL_DISPUTE_CASES = "Dispute cases";
    let COL_CATEGORY      = "Categories";
    let COL_CHANNEL       = "Email/ Calls";

    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSofUgui9FmcQAws1mCv3LGOtUM7IADuZdSblWRs7w6UKl7KB6vnDmKxbxm8lpd-naisKXQLDHCNME2/pub?gid=1315151946&single=true&output=csv";

    // ===== STATE =====
    let allRecords = [];
    const charts = {
      ticketsAgent: null,
      qaAgent: null,
      qaTrend: null,
      disputes: null,
      category: null,
      channel: null
    };

    let currentFrom = null;
    let currentTo = null;
    let currentTrendMode = "daily";
    let selectedAgents = [];

    // Column filter/hide state
    let tableFilters = {};      // { colName: Set(values) }
    let hiddenColumns = new Set();
    // Toast notification state
    let activeToasts = [];

    // Toast notification function
    function showToast(title, message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'âœ“',
        info: 'â„¹',
        error: 'âœ•'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <div class="toast-close">Ã—</div>
      `;
      
      document.body.appendChild(toast);
      activeToasts.push(toast);
      
      const closeBtn = toast.querySelector('.toast-close');
      closeBtn.onclick = () => removeToast(toast);
      
      if (duration > 0) {
        setTimeout(() => removeToast(toast), duration);
      }
    }

    function removeToast(toast) {
      toast.classList.add('hiding');
      setTimeout(() => {
        toast.remove();
        activeToasts = activeToasts.filter(t => t !== toast);
      }, 300);
    }
    // Show skeleton loading
    // Show skeleton loading
    function showSkeletonLoading() {
      // KPIs skeleton - only add skeleton, don't store content
      document.querySelectorAll('.kpi').forEach(kpi => {
        const existing = kpi.querySelector('.skeleton');
        if (!existing) {
          kpi.style.position = 'relative';
          kpi.style.overflow = 'hidden';
          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton skeleton-kpi';
          skeleton.style.position = 'absolute';
          skeleton.style.top = '0';
          skeleton.style.left = '0';
          skeleton.style.right = '0';
          skeleton.style.bottom = '0';
          skeleton.style.zIndex = '10';
          kpi.appendChild(skeleton);
        }
      });
      
      // Charts skeleton
      document.querySelectorAll('.chart-card canvas').forEach(canvas => {
        const parent = canvas.parentElement;
        const existing = parent.querySelector('[data-skeleton="true"]');
        if (!existing) {
          canvas.style.opacity = '0.3';
          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton skeleton-chart';
          skeleton.dataset.skeleton = 'true';
          skeleton.style.position = 'absolute';
          skeleton.style.top = '40px';
          skeleton.style.left = '10px';
          skeleton.style.right = '10px';
          skeleton.style.bottom = '10px';
          parent.style.position = 'relative';
          parent.appendChild(skeleton);
        }
      });
      
      // Leaderboard skeleton
      const leaderBadges = leaderListEl.querySelectorAll('.leader-badge');
      if (leaderBadges.length > 0) {
        leaderBadges.forEach(badge => {
          badge.style.opacity = '0.3';
        });
      } else {
        leaderListEl.innerHTML = `
          <li class="leader-badge skeleton skeleton-text short" style="height: 28px; width: 120px;"></li>
          <li class="leader-badge skeleton skeleton-text short" style="height: 28px; width: 120px;"></li>
          <li class="leader-badge skeleton skeleton-text short" style="height: 28px; width: 120px;"></li>
        `;
      }
    }

    // Hide skeleton loading
    function hideSkeletonLoading() {
      // Remove KPI skeletons
      document.querySelectorAll('.kpi .skeleton').forEach(skeleton => {
        skeleton.remove();
      });
      document.querySelectorAll('.kpi').forEach(kpi => {
        kpi.style.position = '';
        kpi.style.overflow = '';
      });
      
      // Remove chart skeletons and restore opacity
      document.querySelectorAll('.chart-card canvas').forEach(canvas => {
        canvas.style.opacity = '';
        const parent = canvas.parentElement;
        const skeleton = parent.querySelector('[data-skeleton="true"]');
        if (skeleton) {
          skeleton.remove();
        }
        parent.style.position = '';
      });
      
      // Restore leaderboard opacity
      const leaderBadges = leaderListEl.querySelectorAll('.leader-badge');
      leaderBadges.forEach(badge => {
        badge.style.opacity = '';
      });
      
      // Remove skeleton badges if they exist
      leaderListEl.querySelectorAll('.skeleton').forEach(sk => sk.remove());
    }

    // ===== ELEMENTS =====
    const tableEl = document.getElementById("data-table");
    const statusTextEl = document.getElementById("status-text");
    const lastUpdatedEl = document.getElementById("last-updated");
    const recordsPillEl = document.getElementById("records-pill");
    const kpiTicketsEl = document.getElementById("kpi-tickets");
    const kpiQaFoundEl = document.getElementById("kpi-qa-found");
    const kpiDisputedEl = document.getElementById("kpi-disputed");
    const kpiFeedbackEl = document.getElementById("kpi-feedback");
    const kpiTicketsDeltaEl = document.getElementById("kpi-tickets-delta");
    const kpiQaDeltaEl = document.getElementById("kpi-qa-delta");
    const fromDateEl = document.getElementById("from-date");
    const toDateEl = document.getElementById("to-date");
    const refreshBtn = document.getElementById("refresh-btn");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeIconEl = document.getElementById("theme-icon");
    const themeLabelEl = document.getElementById("theme-label");
    const toggleTableBtn = document.getElementById("toggle-table-btn");
    const toggleTableLabel = document.getElementById("toggle-table-label");
    const tableSectionEl = document.getElementById("table-section");
    const rangeButtons = document.querySelectorAll(".range-btn");
    const leaderListEl = document.getElementById("leader-list");
    const trendModeEl = document.getElementById("trend-mode");
    const colToggleBtn = document.getElementById("colToggleBtn");
    const colMenuEl = document.getElementById("colMenu");
    const activeFiltersEl = document.getElementById("active-filters");

    // Custom multi-select elements
    const agentDropdown = document.getElementById("agent-dropdown");
    const agentSelectBox = document.getElementById("agent-multiselect");
    const agentOptionsBox = document.getElementById("agent-options");
    const agentSearch = document.getElementById("agent-search");
    const agentChips = document.getElementById("agent-selected-chips");

    // ===== UTILS =====
    function getLabelColor() {
      return document.body.classList.contains("light") ? "#111827" : "#e5e7eb";
    }

    function formatDeltaText(current, previous) {
      if (previous === 0 || previous === null) return "vs prev: â€”";
      const diff = current - previous;
      const pct = (diff / previous) * 100;
      const sign = diff > 0 ? "â–²" : diff < 0 ? "â–¼" : "â—";
      const cls = diff > 0 ? "positive" : diff < 0 ? "negative" : "";
      return { text: `${sign} ${Math.round(pct)}% vs prev`, cls };
    }

    function formatDateInput(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function formatDateDisplay(d) {
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // ===== LOAD DATA =====
    async function loadSheetData(isAutoRefresh = false) {
      statusTextEl.textContent = "Loading dataâ€¦";
      
      // Show skeleton only on initial load or manual refresh
      if (!isAutoRefresh) {
        showSkeletonLoading();
      }

      try {
        const url =
          SHEET_CSV_URL +
          (SHEET_CSV_URL.includes("?") ? "&" : "?") +
          "_=" +
          Date.now();

        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText);

        const csvText = await res.text();
        const rows = parseCsv(csvText);

        if (!rows.length) {
          renderEmptyTable("No data found.");
          updateMeta([]);
          hideSkeletonLoading();
          return;
        }

        const records = csvToRecords(rows);
        allRecords = records;

        const previousAgents = [...selectedAgents];
        populateAgentFilter(records, previousAgents);
        applyFiltersAndRender();

        statusTextEl.textContent = "Loaded " + records.length + " rows.";
        
        // Hide skeleton
        hideSkeletonLoading();
        
        // Show toast notification
        if (isAutoRefresh) {
          showToast(
            'Data Refreshed', 
            `Successfully updated ${records.length} rows at ${new Date().toLocaleTimeString()}`,
            'success',
            2500
          );
        }
      } catch (err) {
        console.error("Fetch error:", err);
        renderEmptyTable("Error: " + err.message);
        statusTextEl.textContent = "Error: " + err.message;
        updateMeta([]);
        hideSkeletonLoading();
        
        // Show error toast
        showToast(
          'Refresh Failed', 
          err.message,
          'error',
          4000
        );
      }
    }

    // ===== CSV HELPERS =====
    function parseCsv(text) {
      const rows = [];
      let currentRow = [];
      let currentValue = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (char === '"' && inQuotes && nextChar === '"') {
          currentValue += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          currentRow.push(currentValue);
          currentValue = "";
        } else if ((char === "\n" || char === "\r") && !inQuotes) {
          if (currentValue || currentRow.length > 0) {
            currentRow.push(currentValue);
            rows.push(currentRow);
            currentRow = [];
            currentValue = "";
          }
        } else {
          currentValue += char;
        }
      }
      if (currentValue || currentRow.length > 0) {
        currentRow.push(currentValue);
        rows.push(currentRow);
      }

      return rows.filter(row => row.some(cell => cell !== ""));
    }

    function detectColumn(header, aliases, keywords = []) {
      const lower = header.map(h => h.toLowerCase().trim());

      for (const a of aliases) {
        const idx = lower.indexOf(a.toLowerCase());
        if (idx !== -1) return header[idx];
      }

      if (keywords.length) {
        for (let i = 0; i < header.length; i++) {
          const h = lower[i];
          if (keywords.every(k => h.includes(k.toLowerCase()))) {
            return header[i];
          }
        }
      }
      return aliases[0];
    }

    function applyColumnDetection(header) {
      COL_MONTH         = detectColumn(header, [COL_MONTH], ["month"]);
      COL_DATE          = detectColumn(header, [COL_DATE], ["date"]);
      COL_WEEK          = detectColumn(header, [COL_WEEK], ["week"]);
      COL_AUDITOR       = detectColumn(header, [COL_AUDITOR], ["auditor"]);
      COL_AGENT         = detectColumn(header, [COL_AGENT], ["agent"]);
      COL_QA_FOUND      = detectColumn(header, [COL_QA_FOUND, "qa q founds", "qa founds"], ["qa"]);
      COL_TICKET_COUNT  = detectColumn(header, [COL_TICKET_COUNT, "ticket count"], ["ticket"]);
      COL_TICKET_ID     = detectColumn(header, [COL_TICKET_ID, "ticket id"], ["ticket"]);
      COL_DISPUTE_CASES = detectColumn(header, [COL_DISPUTE_CASES, "dispute cases"], ["dispute"]);
      COL_CATEGORY      = detectColumn(header, [COL_CATEGORY], ["category"]);
      COL_CHANNEL       = detectColumn(header, [COL_CHANNEL, "email/ calls", "email / calls"], ["email"]);

      console.log("Detected columns:", {
        COL_MONTH,
        COL_DATE,
        COL_WEEK,
        COL_AUDITOR,
        COL_AGENT,
        COL_QA_FOUND,
        COL_TICKET_COUNT,
        COL_TICKET_ID,
        COL_DISPUTE_CASES,
        COL_CATEGORY,
        COL_CHANNEL
      });
    }

    function csvToRecords(rows) {
      const header = rows[0].map(h => h.trim());
      applyColumnDetection(header);
      const dataRows = rows.slice(1);

      return dataRows.map(cells => {
        const obj = {};
        header.forEach((col, i) => {
          obj[col] = cells[i] != null ? cells[i].trim() : "";
        });

        const dStr = obj[COL_DATE];
        obj.__dateObj = parseSheetDate(dStr);

        return obj;
      });
    }

    function parseSheetDate(dStr) {
      if (!dStr) return null;
      dStr = dStr.replace(/[^\x20-\x7E]/g, "").trim();
      const parts = dStr.split("/");
      if (parts.length !== 3) return null;
      let [dd, mm, yyyy] = parts;
      if (yyyy.length === 2) yyyy = "20" + yyyy;
      dd = Number(dd);
      mm = Number(mm);
      yyyy = Number(yyyy);
      if (!dd || !mm || !yyyy) return null;
      const date = new Date(yyyy, mm - 1, dd);
      date.setHours(0, 0, 0, 0);
      return date;
    }

    // ===== FILTER + RENDER =====
    function applyFiltersAndRender() {
      let filtered = [...allRecords];

      // dates
      if (fromDateEl.value) {
        currentFrom = new Date(fromDateEl.value);
        currentFrom.setHours(0, 0, 0, 0);
      } else {
        currentFrom = null;
      }

      if (toDateEl.value) {
        currentTo = new Date(toDateEl.value);
        currentTo.setHours(0, 0, 0, 0);
      } else {
        currentTo = null;
      }

      // agents
      if (selectedAgents.length) {
        filtered = filtered.filter(r => selectedAgents.includes(r[COL_AGENT]));
      }

      // date range
      if (currentFrom) {
        filtered = filtered.filter(r => {
          if (!r.__dateObj) return false;
          return r.__dateObj.getTime() >= currentFrom.getTime();
        });
      }

      if (currentTo) {
        filtered = filtered.filter(r => {
          if (!r.__dateObj) return false;
          return r.__dateObj.getTime() <= currentTo.getTime();
        });
      }

      console.log("Filter applied:", {
        total: allRecords.length,
        filtered: filtered.length,
        fromDate: currentFrom,
        toDate: currentTo,
        selectedAgents
      });

      renderTable(filtered);
      updateMeta(filtered);
      updateCharts(filtered);
      updateActiveFiltersSummary();
    }

    function populateAgentFilter(records, keepAgents = []) {
  const agents = Array.from(
    new Set(records.map(r => r[COL_AGENT]).filter(Boolean))
  ).sort();

  agentOptionsBox.innerHTML = "";

  const keepSet = new Set(keepAgents);
  const newSelection = [];

  agents.forEach(a => {
    const isChecked = keepSet.has(a);

    const row = document.createElement("div");
    row.className = "multi-option";
    row.innerHTML = `
      <input type="checkbox" value="${a}" ${isChecked ? "checked" : ""}>
      <span>${a}</span>
    `;

    row.onclick = (e) => {
      if (e.target.tagName !== "INPUT") {
        const cb = row.querySelector("input");
        cb.checked = !cb.checked;
      }
      updateSelectedAgents();
    };

    if (isChecked) {
      newSelection.push(a);
    }

    agentOptionsBox.appendChild(row);
  });

  // update global selection + label in the pill
  selectedAgents = newSelection;

  if (selectedAgents.length === 0) {
    agentChips.innerHTML = "All agents";
  } else {
    agentChips.innerHTML = selectedAgents
      .map(a => `<span class="chip">${a}</span>`)
      .join("");
  }
}
    // ===== TABLE =====
    function renderEmptyTable(message) {
      tableEl.innerHTML = `
        <tbody>
          <tr><td class="empty-state" colspan="99">${message}</td></tr>
        </tbody>`;
    }

    function renderTable(records) {
  if (!records.length) {
    renderEmptyTable("No records after filters.");
    return;
  }

  const headerCols = Object.keys(records[0]).filter(k => !k.startsWith("__"));
  
  // Only rebuild table if it's empty or structure changed
  const existingHeaders = [...tableEl.querySelectorAll("thead th")].map(th => 
    th.getAttribute("data-col-name") || th.textContent.trim()
  );
  
  const needsRebuild = existingHeaders.length === 0 || 
                       JSON.stringify(existingHeaders) !== JSON.stringify(headerCols);

  if (needsRebuild) {
    let theadHtml = "<thead><tr>";
    headerCols.forEach(col => {
      theadHtml += `<th data-col-name="${escapeHtml(col)}">${escapeHtml(col)}</th>`;
    });
    theadHtml += "</tr></thead>";

    let tbodyHtml = "<tbody>";
    for (const rec of records) {
      tbodyHtml += "<tr>";
      for (const col of headerCols) {
        let value = rec[col] || "";
        if (col === COL_TICKET_ID && value) {
          value = `<a href="${value}" target="_blank" class="ticket-link">View</a>`;
        }
        tbodyHtml += `<td>${value}</td>`;
      }
      tbodyHtml += "</tr>";
    }
    tbodyHtml += "</tbody>";

    tableEl.innerHTML = theadHtml + tbodyHtml;
    enhanceTableWithFilters();
  } else {
    // Just update tbody content without blinking
    let tbodyHtml = "";
    for (const rec of records) {
      tbodyHtml += "<tr>";
      for (const col of headerCols) {
        let value = rec[col] || "";
        if (col === COL_TICKET_ID && value) {
          value = `<a href="${value}" target="_blank" class="ticket-link">View</a>`;
        }
        tbodyHtml += `<td>${value}</td>`;
      }
      tbodyHtml += "</tr>";
    }
    
    const tbody = tableEl.querySelector("tbody");
    if (tbody) {
      tbody.innerHTML = tbodyHtml;
    }
    
    applyAllColumnFilters();
    applyHiddenColumns();
  }
}

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    // ===== METRIC HELPERS =====
    function getQaMetric(raw) {
      const trimmed = (raw || "").trim();
      if (!trimmed) return 0;

      const num = Number(trimmed);
      if (!Number.isNaN(num)) return num;

      const lower = trimmed.toLowerCase();
      if (["yes", "y", "true", "1"].includes(lower)) return 1;
      return 0;
    }

    function getColorPalette(count) {
      const base = [
        "#38bdf8",
        "#fbbf24",
        "#f97316",
        "#22c55e",
        "#a855f7",
        "#ec4899",
        "#14b8a6",
        "#3b82f6"
      ];
      const colors = [];
      for (let i = 0; i < count; i++) {
        colors.push(base[i % base.length]);
      }
      return colors;
    }

    function sortMapDesc(map) {
      return Object.entries(map).sort((a, b) => b[1] - a[1]);
    }

    // ===== KPIs =====
    function updateMeta(records) {
      const rowCount = records.length;

      let tickets = 0;
      let qaFound = 0;
      let disputed = 0;
      let feedbackCount = 0;

      for (const r of records) {
        const t = Number(r[COL_TICKET_COUNT] || 1);
        tickets += Number.isNaN(t) ? 1 : t;

        const cat = (r[COL_CATEGORY] || "").trim();
        const qaMetric = getQaMetric(r[COL_QA_FOUND]);

        if (qaMetric > 0) {
          if (cat === "Feedback") {
            feedbackCount += qaMetric;
          } else {
            qaFound += qaMetric;
          }
        }

        const disputeVal = (r[COL_DISPUTE_CASES] || "").toLowerCase().trim();
        if (disputeVal === "yes") disputed++;
      }

      let prevTickets = null;
      let prevQaFound = null;
      if (currentFrom && currentTo) {
        const spanDays = Math.round((currentTo - currentFrom) / (1000 * 60 * 60 * 24)) + 1;
        const prevFrom = new Date(currentFrom);
        prevFrom.setDate(prevFrom.getDate() - spanDays);
        const prevTo = new Date(currentFrom);
        prevTo.setDate(prevTo.getDate() - 1);

        const prevRecords = allRecords.filter(r => {
          if (!r.__dateObj) return false;
          return r.__dateObj >= prevFrom && r.__dateObj <= prevTo;
        });

        prevTickets = 0;
        prevQaFound = 0;
        for (const r of prevRecords) {
          const t = Number(r[COL_TICKET_COUNT] || 1);
          prevTickets += Number.isNaN(t) ? 1 : t;

          const catPrev = (r[COL_CATEGORY] || "").trim();
          const qaMetricPrev = getQaMetric(r[COL_QA_FOUND]);
          if (qaMetricPrev > 0 && catPrev !== "Feedback") {
            prevQaFound += qaMetricPrev;
          }
        }
      }

      kpiTicketsEl.textContent = tickets;
      kpiQaFoundEl.textContent = qaFound;
      kpiDisputedEl.textContent = disputed;
      kpiFeedbackEl.textContent = feedbackCount;
      recordsPillEl.textContent = rowCount + (rowCount === 1 ? " row" : " rows");
      lastUpdatedEl.textContent = new Date().toLocaleString();

      const tDelta = (currentFrom && currentTo && prevTickets !== null)
        ? formatDeltaText(tickets, prevTickets)
        : { text: "vs prev: â€”", cls: "" };
      const qDelta = (currentFrom && currentTo && prevQaFound !== null)
        ? formatDeltaText(qaFound, prevQaFound)
        : { text: "vs prev: â€”", cls: "" };

      kpiTicketsDeltaEl.textContent = tDelta.text;
      kpiTicketsDeltaEl.className = "kpi-delta " + (tDelta.cls || "");
      kpiQaDeltaEl.textContent = qDelta.text;
      kpiQaDeltaEl.className = "kpi-delta " + (qDelta.cls || "");
    }

    // ===== ACTIVE FILTERS SUMMARY =====
    function updateActiveFiltersSummary() {
  activeFiltersEl.innerHTML = "";

  // --- AGENT FILTER CHIPS ---
  if (selectedAgents.length > 0) {
    selectedAgents.forEach(agent => {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `${agent} <span class="chip-close" data-agent="${agent}">âœ•</span>`;
      activeFiltersEl.appendChild(chip);
    });
  } else {
    activeFiltersEl.innerHTML = '<span class="chip chip-muted">No filters applied</span>';
  }

  // --- DATE FILTER CHIPS ---
  if (currentFrom && currentTo) {
    addDateChip(`Date: ${formatDateDisplay(currentFrom)} â†’ ${formatDateDisplay(currentTo)}`, "date-range");
  } else if (currentFrom) {
    addDateChip(`From: ${formatDateDisplay(currentFrom)}`, "from-date");
  } else if (currentTo) {
    addDateChip(`To: ${formatDateDisplay(currentTo)}`, "to-date");
  }

  attachChipHandlers();
}

function addDateChip(text, type) {
  const chip = document.createElement("span");
  chip.className = "chip";
  chip.innerHTML = `${text} <span class="chip-close" data-type="${type}">âœ•</span>`;
  activeFiltersEl.appendChild(chip);
}

// Handle X-clicks on chips
function attachChipHandlers() {
  document.querySelectorAll(".chip-close").forEach(btn => {
    btn.onclick = () => {
      const agent = btn.dataset.agent;
      const type = btn.dataset.type;

      // Agent chip removed
      if (agent) {
        // Uncheck in dropdown
        const checkbox = [...agentOptionsBox.querySelectorAll("input")].find(i => i.value === agent);
        if (checkbox) checkbox.checked = false;

        // This will:
        // - rebuild selectedAgents from checked boxes
        // - update the Agent pill (agentChips)
        // - call applyFiltersAndRender()
        updateSelectedAgents();
        return; // already re-rendered, so exit
      }

      // Date chips removed
      if (type === "date-range") {
        fromDateEl.value = "";
        toDateEl.value = "";
      }
      if (type === "from-date") {
        fromDateEl.value = "";
      }
      if (type === "to-date") {
        toDateEl.value = "";
      }

      applyFiltersAndRender();
    };
  });
}



    // ===== CHARTS + LEADERBOARD =====
    function updateCharts(records) {
      const ticketsByAuditor = {};
      const qaByAgent = {};
      const qaTrendDaily = {};
      const qaTrendWeekly = {};
      const qaTrendMonthly = {};
      const disputeCounts = { Disputed: 0, "Not Disputed": 0 };
      const categoryCounts = {};
      const channelCounts = {};

      for (const r of records) {
        const auditor = r[COL_AUDITOR] || "Unknown";
        const agent = r[COL_AGENT] || "Unknown";
        const ticketCount = Number(r[COL_TICKET_COUNT] || 1);
        const qaMetric = getQaMetric(r[COL_QA_FOUND]);
        const disputeVal = (r[COL_DISPUTE_CASES] || "").toLowerCase().trim();
        const rawCategory = (r[COL_CATEGORY] || "").trim();
        const channel = (r[COL_CHANNEL] || "Unknown").trim() || "Unknown";

        ticketsByAuditor[auditor] =
          (ticketsByAuditor[auditor] || 0) + (Number.isNaN(ticketCount) ? 1 : ticketCount);

        const isFeedback = rawCategory === "Feedback";

        if (qaMetric > 0 && !isFeedback) {
          qaByAgent[agent] = (qaByAgent[agent] || 0) + qaMetric;

          if (r.__dateObj) {
            const yyyy = r.__dateObj.getFullYear();
            const mm = String(r.__dateObj.getMonth() + 1).padStart(2, "0");
            const dd = String(r.__dateObj.getDate()).padStart(2, "0");
            const dKey = `${yyyy}-${mm}-${dd}`;
            qaTrendDaily[dKey] = (qaTrendDaily[dKey] || 0) + qaMetric;

            const weekKey = (r[COL_WEEK] || "").toString() || `W${yyyy}-${mm}`;
            qaTrendWeekly[weekKey] = (qaTrendWeekly[weekKey] || 0) + qaMetric;

            const monthKey = r[COL_MONTH] || `${yyyy}-${mm}`;
            qaTrendMonthly[monthKey] = (qaTrendMonthly[monthKey] || 0) + qaMetric;
          }

          if (disputeVal === "yes") {
            disputeCounts["Disputed"] += qaMetric;
          } else {
            disputeCounts["Not Disputed"] += qaMetric;
          }
        }

        if (rawCategory && rawCategory !== "Feedback") {
          categoryCounts[rawCategory] = (categoryCounts[rawCategory] || 0) + 1;
        }
        channelCounts[channel] = (channelCounts[channel] || 0) + 1;
      }

      const ticketEntries = sortMapDesc(ticketsByAuditor);
      const ticketLabels = ticketEntries.map(e => e[0]);
      const ticketValues = ticketEntries.map(e => e[1]);

      const qaEntries = sortMapDesc(qaByAgent);
      const qaAgents = qaEntries.map(e => e[0]);
      const qaValues = qaEntries.map(e => e[1]);

      let trendLabels = [];
      let trendValues = [];

      if (currentTrendMode === "daily") {
        const keys = Object.keys(qaTrendDaily).sort();
        trendLabels = keys.map(k => k.slice(8, 10) + "/" + k.slice(5, 7));
        trendValues = keys.map(k => qaTrendDaily[k]);
      } else if (currentTrendMode === "weekly") {
        const keys = Object.keys(qaTrendWeekly).sort((a,b) => Number(a) - Number(b));
        trendLabels = keys;
        trendValues = keys.map(k => qaTrendWeekly[k]);
      } else {
        const keys = Object.keys(qaTrendMonthly).sort();
        trendLabels = keys;
        trendValues = keys.map(k => qaTrendMonthly[k]);
      }

      const disputeLabels = Object.keys(disputeCounts);
      const disputeValues = disputeLabels.map(k => disputeCounts[k]);

      const categoryEntries = sortMapDesc(categoryCounts);
      const categoryLabels = categoryEntries.map(e => e[0]);
      const categoryVals = categoryEntries.map(e => e[1]);

      const channelLabels = Object.keys(channelCounts);
      const channelVals = channelLabels.map(k => channelCounts[k]);

      const auditorColors = getColorPalette(ticketLabels.length);
      const agentColors = getColorPalette(qaAgents.length);
      const catColors = getColorPalette(categoryLabels.length);

      const DISPUTE_COLORS = ["#22c55e", "#60a5fa"];
      const CHANNEL_COLORS = ["#60a5fa", "#22c55e", "#a855f7"];

      updateBarChart(
        "chart-tickets-agent",
        "Tickets Audited",
        ticketLabels,
        ticketValues,
        "ticketsAgent",
        auditorColors,
        "Auditor",
        "Tickets"
      );
      updateBarChart(
        "chart-qa-agent",
        "QA Found",
        qaAgents,
        qaValues,
        "qaAgent",
        agentColors,
        "Agent",
        "QA Found"
      );
      updateLineChart(
        "chart-qa-trend",
        `QA Found (${currentTrendMode})`,
        trendLabels,
        trendValues,
        "qaTrend",
        currentTrendMode === "daily" ? "Date" : currentTrendMode === "weekly" ? "Week" : "Month",
        "QA Found"
      );
      updateDoughnut(
        "chart-disputes",
        disputeLabels,
        disputeValues,
        "disputes",
        DISPUTE_COLORS.slice(0, disputeLabels.length)
      );
      updateBarChart(
        "chart-category",
        "QA Count",
        categoryLabels,
        categoryVals,
        "category",
        catColors,
        "Category",
        "Count"
      );
      updateDoughnut(
        "chart-channel",
        channelLabels,
        channelVals,
        "channel",
        CHANNEL_COLORS.slice(0, channelLabels.length)
      );

      renderLeaderboard(qaEntries.slice(0, 3));
    }

    function renderLeaderboard(entries) {
      if (!entries.length) {
        leaderListEl.innerHTML = "<li class='leader-badge'>No QA findings in this period.</li>";
        return;
      }
      leaderListEl.innerHTML = "";
      entries.forEach((entry, idx) => {
        const li = document.createElement("li");
        li.className = "leader-badge";
        li.textContent = (idx + 1) + ". " + entry[0] + " â€“ " + entry[1];
        leaderListEl.appendChild(li);
      });
    }

    // ===== CHART HELPERS =====
    function baseLabelOptions() {
      return {
        anchor: "end",
        align: "end",
        offset: -2,
        font: { size: 10, weight: "500" },
        color: getLabelColor(),
        formatter: (v) => (v ? v : "")
      };
    }

    function updateBarChart(id, label, labels, values, key, colors, xTitle, yTitle) {
      const ctx = document.getElementById(id).getContext("2d");
      const datalabelsOpts = baseLabelOptions();

      const maxVal = values.length ? Math.max(...values) : 0;
      const suggestedMax = maxVal ? maxVal * 1.2 : undefined;

      if (!charts[key]) {
        charts[key] = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label,
              data: values,
              backgroundColor: colors,
              borderRadius: 6
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              tooltip: { enabled: true },
              datalabels: datalabelsOpts
            },
            scales: {
              x: {
                ticks: { font: { size: 10 } },
                title: {
                  display: !!xTitle,
                  text: xTitle,
                  font: { size: 11 }
                }
              },
              y: {
                beginAtZero: true,
                suggestedMax,
                title: {
                  display: !!yTitle,
                  text: yTitle,
                  font: { size: 11 }
                }
              }
            }
          }
        });
      } else {
        charts[key].data.labels = labels;
        charts[key].data.datasets[0].data = values;
        charts[key].data.datasets[0].backgroundColor = colors;
        charts[key].options.plugins.datalabels = datalabelsOpts;
        charts[key].options.scales.y.suggestedMax = suggestedMax;
        charts[key].update();
      }
    }

    function updateLineChart(id, label, labels, values, key, xTitle, yTitle) {
      const ctx = document.getElementById(id).getContext("2d");
      const datalabelsOpts = {
        ...baseLabelOptions(),
        anchor: "end",
        align: "top"
      };

      const maxVal = values.length ? Math.max(...values) : 0;
      const suggestedMax = maxVal ? maxVal * 1.2 : undefined;

      if (!charts[key]) {
        charts[key] = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label,
              data: values,
              tension: 0.4,
              fill: false
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              tooltip: { enabled: true },
              datalabels: datalabelsOpts
            },
            scales: {
              x: {
                ticks: { font: { size: 10 } },
                title: {
                  display: !!xTitle,
                  text: xTitle,
                  font: { size: 11 }
                }
              },
              y: {
                beginAtZero: true,
                suggestedMax,
                title: {
                  display: !!yTitle,
                  text: yTitle,
                  font: { size: 11 }
                }
              }
            }
          }
        });
      } else {
        charts[key].data.labels = labels;
        charts[key].data.datasets[0].data = values;
        charts[key].options.plugins.datalabels = datalabelsOpts;
        charts[key].options.scales.y.suggestedMax = suggestedMax;
        charts[key].update();
      }
    }

    function updateDoughnut(id, labels, values, key, colors) {
      const ctx = document.getElementById(id).getContext("2d");
      const datasetColors = colors || getColorPalette(labels.length);

      const options = {
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom", labels: { font: { size: 11 } } },
          tooltip: { enabled: true },
          datalabels: {
            color: getLabelColor(),
            font: { size: 12, weight: "600" },
            formatter: (value) => (value ? value : "")
          }
        },
        cutout: "40%"
      };

      if (!charts[key]) {
        charts[key] = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: datasetColors,
              borderWidth: 2,
              borderColor: "#ffffff"
            }]
          },
          options
        });
      } else {
        charts[key].data.labels = labels;
        charts[key].data.datasets[0].data = values;
        charts[key].data.datasets[0].backgroundColor = datasetColors;
        charts[key].data.datasets[0].borderWidth = 2;
        charts[key].data.datasets[0].borderColor = "#ffffff";
        charts[key].options = options;
        charts[key].update();
      }
    }

    // ===== THEME =====
    function refreshLabelColorsForTheme() {
      const labelColor = getLabelColor();
      Object.values(charts).forEach(ch => {
        if (!ch) return;
        if (!ch.options.plugins) ch.options.plugins = {};
        if (!ch.options.plugins.datalabels) ch.options.plugins.datalabels = {};
        ch.options.plugins.datalabels.color = labelColor;
        ch.update();
      });
    }

    function setTheme(theme) {
      if (theme === "light") {
        document.body.classList.add("light");
        themeIconEl.textContent = "â˜€ï¸";
        themeLabelEl.textContent = "Light";
      } else {
        document.body.classList.remove("light");
        themeIconEl.textContent = "ðŸŒ™";
        themeLabelEl.textContent = "Dark";
      }
      localStorage.setItem("qaTheme", theme);
      refreshLabelColorsForTheme();
    }

    function initTheme() {
      const saved = localStorage.getItem("qaTheme") || "dark";
      setTheme(saved);
    }

    // ===== QUICK DATE RANGES =====
    function applyQuickRange(days) {
      if (days === 0) {
        fromDateEl.value = "";
        toDateEl.value = "";
        applyFiltersAndRender();
        return;
      }

      const dates = allRecords
        .map(r => r.__dateObj)
        .filter(d => d instanceof Date && !Number.isNaN(d.getTime()));

      if (!dates.length) return;

      const maxTime = Math.max(...dates.map(d => d.getTime()));
      const latestDate = new Date(maxTime);
      latestDate.setHours(0, 0, 0, 0);

      const from = new Date(latestDate);
      from.setDate(from.getDate() - (days - 1));

      fromDateEl.value = formatDateInput(from);
      toDateEl.value = formatDateInput(latestDate);
      applyFiltersAndRender();
    }

    // ===== COLUMN FILTER + HIDE SYSTEM =====
    function enhanceTableWithFilters() {
      const table = document.getElementById("data-table");
      if (!table) return;

      const thead = table.querySelector("thead");
      if (!thead) return;
      const headerCells = [...thead.querySelectorAll("th")];

      headerCells.forEach((th, index) => {
        const colName = th.getAttribute("data-col-name") || th.textContent.trim();
        th.setAttribute("data-col-name", colName);

        if (!th.querySelector(".header-filter")) {
          const icon = document.createElement("span");
          icon.textContent = "â–¼";
          icon.className = "header-filter";
          icon.onclick = (e) => {
            e.stopPropagation();
            openFilterMenu(colName, index);
          };
          th.appendChild(icon);
        }
      });

      buildColumnVisibilityMenu(headerCells.map(h => h.getAttribute("data-col-name")));
      applyAllColumnFilters();
      applyHiddenColumns();
    }

    function buildColumnVisibilityMenu(columns) {
      colMenuEl.innerHTML = "";
      columns.forEach(col => {
        const row = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !hiddenColumns.has(col);

        cb.onchange = () => toggleColumn(col, cb.checked);

        row.appendChild(cb);
        row.appendChild(document.createTextNode(col));
        colMenuEl.appendChild(row);
      });
    }

    function toggleColumn(colName, show) {
      const table = document.getElementById("data-table");
      const headers = [...table.querySelectorAll("th")];
      const index = headers.findIndex(th => (th.getAttribute("data-col-name") || "").trim() === colName.trim());
      if (index < 0) return;

      const display = show ? "" : "none";

      table.querySelectorAll("tr").forEach(row => {
        const cell = row.children[index];
        if (cell) cell.style.display = display;
      });

      if (!show) hiddenColumns.add(colName);
      else hiddenColumns.delete(colName);
    }

    function applyHiddenColumns() {
      const table = document.getElementById("data-table");
      const headers = [...table.querySelectorAll("th")];
      headers.forEach((th, index) => {
        const colName = th.getAttribute("data-col-name") || th.textContent.trim();
        const show = !hiddenColumns.has(colName);
        const display = show ? "" : "none";
        table.querySelectorAll("tr").forEach(row => {
          const cell = row.children[index];
          if (cell) cell.style.display = display;
        });
      });
    }

    function openFilterMenu(colName, colIndex) {
      const values = new Set();
      const rows = document.querySelectorAll("#data-table tbody tr");

      rows.forEach(r => {
        const cell = r.children[colIndex];
        if (cell) values.add(cell.innerText.trim());
      });

      const menu = document.createElement("div");
      const styles = getComputedStyle(document.body);
      const bg = styles.getPropertyValue("--card-bg") || "#ffffff";
      const fg = styles.getPropertyValue("--text-main") || "#000000";

      menu.style.position = "absolute";
      menu.style.background = bg;
      menu.style.color = fg;
      menu.style.padding = "8px";
      menu.style.border = "1px solid " + (styles.getPropertyValue("--border-subtle") || "#ccc");
      menu.style.borderRadius = "8px";
      menu.style.zIndex = "9999";
      menu.style.maxHeight = "220px";
      menu.style.overflowY = "auto";
      menu.style.minWidth = "180px";
      menu.classList.add("filter-menu");

      const th = document.querySelectorAll("#data-table thead th")[colIndex];
      const rect = th.getBoundingClientRect();
      menu.style.left = rect.left + "px";
      menu.style.top = (rect.bottom + window.scrollY) + "px";

      menu.innerHTML = `
        <div style="font-size:12px; margin-bottom:6px;"><b>${colName}</b></div>
        <input type="text" id="searchFilter" placeholder="search..." style="width:95%; padding:4px; font-size:11px; margin-bottom:4px;">
        <div style="font-size:11px; margin-bottom:4px;">
          <a href="#" id="selectAll">Select all</a> Â·
          <a href="#" id="clearAll">Clear</a>
        </div>
      `;

      const list = document.createElement("div");
      values.forEach(v => {
        const lbl = document.createElement("label");
        lbl.style.fontSize = "11px";
        lbl.style.display = "flex";
        lbl.style.gap = "6px";

        const cb = document.createElement("input");
        cb.type = "checkbox";

        const allowed = tableFilters[colName];
        cb.checked = !allowed || allowed.has(v);

        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(v || "(blank)"));
        list.appendChild(lbl);
      });

      menu.appendChild(list);

      document.querySelectorAll(".filter-menu").forEach(e => e.remove());
      document.body.appendChild(menu);

      const searchInput = menu.querySelector("#searchFilter");
      searchInput.onkeyup = (e) => {
        const text = e.target.value.toLowerCase();
        [...list.children].forEach(lbl => {
          lbl.style.display = lbl.innerText.toLowerCase().includes(text) ? "" : "none";
        });
      };

      menu.querySelector("#selectAll").onclick = (e) => {
        e.preventDefault();
        list.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = true);
        applyColumnFilter(colName, colIndex);
      };

      menu.querySelector("#clearAll").onclick = (e) => {
        e.preventDefault();
        list.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
        applyColumnFilter(colName, colIndex);
      };

      list.querySelectorAll("input[type='checkbox']").forEach(cb => {
        cb.onchange = () => applyColumnFilter(colName, colIndex);
      });

      document.addEventListener("click", function handle(e) {
        if (!menu.contains(e.target) && !th.contains(e.target)) {
          menu.remove();
          document.removeEventListener("click", handle);
        }
      });
    }

    function applyColumnFilter(colName, colIndex) {
      const menu = document.querySelector(".filter-menu");
      if (!menu) return;

      const labels = menu.querySelectorAll("label");
      const allowed = new Set();
      labels.forEach(lbl => {
        const cb = lbl.querySelector("input");
        if (cb && cb.checked) {
          allowed.add(lbl.innerText.trim().replace("(blank)", ""));
        }
      });

      tableFilters[colName] = allowed;
      applyAllColumnFilters();
    }

    function applyAllColumnFilters() {
      const rows = document.querySelectorAll("#data-table tbody tr");
      const headers = [...document.querySelectorAll("#data-table thead th")];

      rows.forEach(r => {
        let visible = true;
        Object.entries(tableFilters).forEach(([colName, allowed]) => {
          if (!allowed || allowed.size === 0) return;
          const idx = headers.findIndex(th => (th.getAttribute("data-col-name") || "").trim() === colName.trim());
          if (idx < 0) return;
          const cell = r.children[idx];
          const val = cell ? cell.innerText.trim() : "";
          if (!allowed.has(val) && !(val === "" && allowed.has(""))) {
            visible = false;
          }
        });
        r.style.display = visible ? "" : "none";
      });
    }

    // Column menu toggle
    colToggleBtn.addEventListener("click", () => {
      colMenuEl.classList.toggle("hidden");
    });

    // ===== CUSTOM MULTI SELECT AGENT DROPDOWN =====
    agentSelectBox.addEventListener("click", () => {
      const isHidden = agentDropdown.classList.contains("hidden");
      if (isHidden) {
        agentDropdown.classList.remove("hidden");
        document.body.classList.add("no-scroll");
      } else {
        agentDropdown.classList.add("hidden");
        document.body.classList.remove("no-scroll");
      }
    });

    function updateSelectedAgents() {
      selectedAgents = [...agentOptionsBox.querySelectorAll("input:checked")].map(i => i.value);

      if (selectedAgents.length === 0) {
        agentChips.innerHTML = "All agents";
      } else {
        agentChips.innerHTML = selectedAgents
          .map(a => `<span class="chip">${a}</span>`)
          .join("");
      }

      applyFiltersAndRender();
    }

    agentSearch.addEventListener("keyup", () => {
      const term = agentSearch.value.toLowerCase();
      [...agentOptionsBox.children].forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
      });
    });

    document.addEventListener("click", (e) => {
      if (!agentSelectBox.contains(e.target) && !agentDropdown.contains(e.target)) {
        if (!agentDropdown.classList.contains("hidden")) {
          agentDropdown.classList.add("hidden");
          document.body.classList.remove("no-scroll");
        }
      }
    });
    // Close Agent dropdown on ESC key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    if (!agentDropdown.classList.contains("hidden")) {
      agentDropdown.classList.add("hidden");
      document.body.classList.remove("no-scroll");
    }
  }
});


    // ===== EVENTS =====
    refreshBtn.addEventListener("click", () => {
      showToast('Refreshing Data', 'Fetching latest data from sheet...', 'info', 1500);
      loadSheetData(false);
    });
    fromDateEl.addEventListener("change", applyFiltersAndRender);
    toDateEl.addEventListener("change", applyFiltersAndRender);

    themeToggleBtn.addEventListener("click", () => {
      const current = document.body.classList.contains("light") ? "light" : "dark";
      setTheme(current === "light" ? "dark" : "light");
    });

    toggleTableBtn.addEventListener("click", () => {
      const hidden = tableSectionEl.classList.contains("hidden");
      if (hidden) {
        tableSectionEl.classList.remove("hidden");
        toggleTableLabel.textContent = "Hide Raw Data";
        tableSectionEl.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        tableSectionEl.classList.add("hidden");
        toggleTableLabel.textContent = "Show Raw Data";
      }
    });

    rangeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const days = Number(btn.dataset.days || "0");
        rangeButtons.forEach(b => b.classList.remove("active"));
        if (days !== 0) {
          btn.classList.add("active");
        }
        applyQuickRange(days);
      });
    });

    trendModeEl.addEventListener("change", () => {
      currentTrendMode = trendModeEl.value;
      applyFiltersAndRender();
    });

    // ===== INIT =====
    initTheme();
    loadSheetData(false); // Initial load with skeleton
// ===== AUTO REFRESH EVERY 10 SECONDS =====
    setInterval(() => {
      console.log("Auto-refreshing data...");
      loadSheetData(true); // Pass true to indicate auto-refresh
    }, 60000); // 10,000 ms = 10 seconds
  </script>
</body>
</html>
